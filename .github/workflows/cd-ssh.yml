name: CD â€“ Build, Push & Deploy to GCE

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: ./boj_contest
          file: boj_contest/dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/mjsec-boj:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/mjsec-boj:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      REMOTE_DIR: ${{ secrets.REMOTE_APP_DIR }}
      DOMAIN: ${{ secrets.DOMAIN }}
      LETSENCRYPT_EMAIL: ${{ secrets.LETSENCRYPT_EMAIL }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ 0. SSH ì¤€ë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.GCP_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          if [ -n "${{ secrets.GCP_HOST_KEY }}" ]; then
            echo "${{ secrets.GCP_HOST_KEY }}" >> ~/.ssh/known_hosts
          fi

      - name: Test SSH
        run: ssh -o ConnectTimeout=10 ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} "echo OK"

      # â”€â”€ 1. ë””ë ‰í„°ë¦¬ & .deploy.env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Prepare remote directory & .deploy.env
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} \
            REMOTE_DIR='${{ secrets.REMOTE_APP_DIR }}' \
            DOMAIN='${{ secrets.DOMAIN }}' \
            LETSENCRYPT_EMAIL='${{ secrets.LETSENCRYPT_EMAIL }}' \
            IMAGE_TAG='${{ github.sha }}' \
            DOCKERHUB_USERNAME='${{ secrets.DOCKERHUB_USERNAME }}' \
            bash -s <<'EOF'
            set -euo pipefail
            : "${REMOTE_DIR:?}"; : "${DOMAIN:?}"; : "${LETSENCRYPT_EMAIL:?}"; : "${IMAGE_TAG:?}"; : "${DOCKERHUB_USERNAME:?}"

            mkdir -p "$REMOTE_DIR"/{nginx,certbot/{config,www,logs}}
            # ê¸°ì¡´ .env ìœ ì§€í•˜ê³ , ë°°í¬ ë³€ìˆ˜ëŠ” .deploy.envë¡œ ë³„ë„ ê´€ë¦¬
            [ -f "$REMOTE_DIR/.env" ] || touch "$REMOTE_DIR/.env"
            cat > "$REMOTE_DIR/.deploy.env" <<EOT
            DOMAIN=$DOMAIN
            LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL
            IMAGE_TAG=$IMAGE_TAG
            DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME
            EOT
            EOF

      # â”€â”€ 2. HTTP-only í…œí”Œë¦¿ & Compose ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload HTTP-only Nginx template and compose
        run: |
          scp -o StrictHostKeyChecking=no nginx/default.http.conf.template \
            ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:"${{ env.REMOTE_DIR }}/nginx/default.conf.template"
          scp -o StrictHostKeyChecking=no docker-compose.prod.yml \
            ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:"${{ env.REMOTE_DIR }}/"

      # â”€â”€ 3. ìŠ¤íƒ ê¸°ë™ (80) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Start HTTP-only stack
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} "
            set -euo pipefail
            cd '${{ env.REMOTE_DIR }}'

            if docker compose version >/dev/null 2>&1; then
              C='docker compose'
            elif command -v docker-compose >/dev/null 2>&1; then
              C='docker-compose'
            else
              echo 'ERROR: docker compose / docker-compose not found on remote host' >&2
              exit 1
            fi

            # ğŸ”¥ ì—¬ê¸°ì„œ .deploy.env ë‚´ìš©ì„ í™˜ê²½ë³€ìˆ˜ë¡œ export
            set -a
            . ./.deploy.env
            set +a

            \$C -f docker-compose.prod.yml down --remove-orphans || true
            \$C -f docker-compose.prod.yml up -d nginx web
          "


      # â”€â”€ 4. HTTP ì‘ë‹µ ëŒ€ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Wait for HTTP
        run: |
          for i in {1..24}; do
            if curl -sSf -m 5 http://${{ env.DOMAIN }} >/dev/null 2>&1; then
              echo "HTTP OK"; break
            fi
            echo "...waiting HTTP (${i}/24)"; sleep 5
          done

      # â”€â”€ 5. ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Issue / Renew SSL
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} "
            cd '${{ env.REMOTE_DIR }}' &&
            if docker compose version >/dev/null 2>&1; then C='docker compose'; else C='docker-compose'; fi &&
            \$C -f docker-compose.prod.yml run --rm certbot \
              certonly --webroot -w /var/www/certbot \
              --non-interactive --keep-until-expiring \
              --email '${{ env.LETSENCRYPT_EMAIL }}' -d '${{ env.DOMAIN }}' \
              --agree-tos --no-eff-email --rsa-key-size 4096
          "

      # â”€â”€ 6. SSL helper íŒŒì¼ í™•ë³´(+ë””ë ‰í„°ë¦¬ ë³´ì¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Provide ssl helper files for nginx
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} <<'EOF'
            set -euo pipefail
            cd '${{ env.REMOTE_DIR }}'
            if docker compose version >/dev/null 2>&1; then C='docker compose'; else C='docker-compose'; fi
            \$C -f docker-compose.prod.yml run --rm --entrypoint "" certbot sh -euxc '
              OPTIONS=/etc/letsencrypt/options-ssl-nginx.conf
              DHPARAM=/etc/letsencrypt/ssl-dhparams.pem
              mkdir -p /etc/letsencrypt
              if [ ! -f "$OPTIONS" ]; then
                SRC=$(find /usr /opt -maxdepth 7 -type f -name options-ssl-nginx.conf 2>/dev/null | head -n1 || true)
                if [ -n "$SRC" ]; then
                  cp "$SRC" "$OPTIONS"
                elif command -v curl >/dev/null 2>&1; then
                  curl -fsSL https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf -o "$OPTIONS" || true
                fi
              fi
              if [ ! -s "$OPTIONS" ]; then
                printf "%s\n" \
                  "ssl_session_cache   shared:SSL:10m;" \
                  "ssl_session_timeout 1h;" \
                  "ssl_prefer_server_ciphers on;" \
                  "ssl_protocols TLSv1.2 TLSv1.3;" \
                  "ssl_ciphers EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;" \
                  > "$OPTIONS"
              fi
              if [ ! -f "$DHPARAM" ]; then
                openssl dhparam -out "$DHPARAM" 2048
              fi
            '
          EOF

      # â”€â”€ 7. HTTPS í…œí”Œë¦¿ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload HTTPS Nginx template
        run: |
          scp -o StrictHostKeyChecking=no nginx/default.https.conf.template \
            ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }}:"${{ env.REMOTE_DIR }}/nginx/default.conf.template"

      # â”€â”€ 8. conf ì¬ìƒì„± & nginx reload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Apply HTTPS config & reload nginx
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} <<'EOF'
            set -euo pipefail
            cd '${{ env.REMOTE_DIR }}'
            if docker compose version >/dev/null 2>&1; then C='docker compose'; else C='docker-compose'; fi
            \$C -f docker-compose.prod.yml exec nginx sh -c "
              envsubst '\$DOMAIN' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf &&
              nginx -s reload
            "
          EOF

      # â”€â”€ 9. ìµœì‹  ì´ë¯¸ì§€ pull & ì „ì²´ ìŠ¤íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy latest stack
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} "
            set -euo pipefail
            cd '${{ env.REMOTE_DIR }}'

            if docker compose version >/dev/null 2>&1; then
              C='docker compose'
            elif command -v docker-compose >/dev/null 2>&1; then
              C='docker-compose'
            else
              echo 'ERROR: docker compose / docker-compose not found on remote host' >&2
              exit 1
            fi

            set -a
            . ./.deploy.env
            set +a

            \$C -f docker-compose.prod.yml pull
            \$C -f docker-compose.prod.yml up -d --remove-orphans
          "


      # â”€â”€ 10. HTTPS ê²€ì¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify HTTPS
        run: |
          for i in {1..12}; do
            if curl -sSf -m 5 https://${{ env.DOMAIN }} >/dev/null 2>&1; then
              echo "HTTPS OK"; break
            fi
            echo "...waiting HTTPS (${i}/12)"; sleep 10
          done

      # â”€â”€ 11. ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Prune images
        run: |
          ssh ${{ secrets.GCP_USER }}@${{ secrets.GCP_HOST }} "docker image prune -f --filter 'until=24h' || true"

  notify:
    needs: [ build-and-push, deploy ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Success notice
        if: success()
        run: echo "Deployed to ${{ secrets.DOMAIN }}"
      - name: Failure notice
        if: failure()
        run: echo "Deployment to ${{ secrets.DOMAIN }} failed"

